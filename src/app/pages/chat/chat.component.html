@let chat = selectedChat();

<ng-container *ngIf="chat; else noChatSelected">
    <!-- Barra superior del chat activo -->
    <mat-toolbar class="chat-toolbar">
        <button mat-icon-button class="back-button" (click)="onBack()">
            <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="chat-header-avatar">
            <img [src]="chat.avatar" [alt]="chat.name" class="chat-avatar" />
            <span class="status-indicator" [class.online]="chat.online"></span>
        </div>
        <div class="chat-header-info">
            <span class="chat-name">{{ chat.name }}</span>
            <span class="chat-status">{{
                chat.online ? 'En línea' : 'Última vez hoy'
                }}</span>
        </div>
        <span class="toolbar-spacer"></span>
        <button mat-icon-button>
            <mat-icon>search</mat-icon>
        </button>
        <button mat-icon-button>
            <mat-icon>more_vert</mat-icon>
        </button>
    </mat-toolbar>

    <!-- Mensajes del chat -->
    <div class="message-container">
        <div *ngFor="let message of chat.messages" [ngClass]="
                  message.sender === 'me'
                    ? 'message-row message-row-right'
                    : 'message-row message-row-left'
                ">
            <div class="message-bubble" [class.message-mine]="message.sender === 'me'"
                [class.message-other]="message.sender === 'other'">
                <div class="message-text">{{ message.text }}</div>
                <div class="message-info">
                    <span class="message-time">{{
                        message.timestamp | date: 'shortTime'
                        }}</span>
                    <span *ngIf="message.sender === 'me'" class="message-status">
                        <mat-icon [class.read]="message.read">{{
                            message.read ? 'done_all' : 'done'
                            }}</mat-icon>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de entrada de mensajes -->
    <div class="input-container">
        <button mat-icon-button type="button">
            <mat-icon>sentiment_satisfied_alt</mat-icon>
        </button>
        <button mat-icon-button type="button">
            <mat-icon>attach_file</mat-icon>
        </button>
        <form (ngSubmit)="onSubmit()" #messageForm="ngForm" class="message-form">
            <mat-form-field appearance="outline" class="message-input" subscriptSizing="dynamic">
                <input matInput placeholder="Escribe un mensaje" [(ngModel)]="newMessage" name="message" />
            </mat-form-field>
            <button mat-mini-fab color="secondary" class="send-button" type="submit" [disabled]="!newMessage.trim()">
                <mat-icon>send</mat-icon>
            </button>
        </form>
    </div>
</ng-container>

<!-- Pantalla cuando no hay chat seleccionado -->
<ng-template #noChatSelected>
    @if(isHandset$ | async) {
    <app-chat-list />
    }@else{
    <mat-toolbar color="primary" class="main-toolbar">
        <span class="toolbar-spacer"></span>
        <button mat-icon-button *ngIf="chat">
            <mat-icon>search</mat-icon>
        </button>
        <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #menu="matMenu">
            <button mat-menu-item>
                <mat-icon>person</mat-icon>
                <span>Perfil</span>
            </button>
            <button mat-menu-item>
                <mat-icon>settings</mat-icon>
                <span>Configuración</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item>
                <mat-icon>exit_to_app</mat-icon>
                <span>Cerrar sesión</span>
            </button>
        </mat-menu>
    </mat-toolbar>
    <div class="no-chat-selected">
        <mat-icon class="no-chat-icon">chat</mat-icon>
        <h2>Selecciona un chat para comenzar</h2>
        <p>Elige una conversación de la lista para ver los mensajes</p>
    </div>
    }
</ng-template>